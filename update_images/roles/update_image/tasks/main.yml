---
# tasks file for base_image
- name: Ensure requirements in place
  package:
    name:
      - guestfs-tools
    state: present
  become: yes

- name: Get VMs list
  community.libvirt.virt:
    command: list_vms
  register: existing_vms
  changed_when: no

- name: Clone the base vm
  command: |
    virt-clone --auto-clone \
    --original {{ item }} \
    --name {{ item }}-update
  when: "item in existing_vms.list_vms"
  loop: "{{ image_list }}"

- name: Update image
  command: |
    virt-customize -d {{ item }}-update --selinux-relabel
    --update
  when: "item in existing_vms.list_vms"
  loop: "{{ image_list }}"
  register: _update_result
  async: 1200
  poll: 0

- name: Wait for updates to complete
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: _jobs
  until: _jobs.finished
  retries: 1200
  delay: 1
  loop: "{{ _update_result.results }}"

- pause:
    prompt: "Does the updates succeded? (y/n)"
    echo: yes
  register: "update_succeded_result"

- set_fact:
    update_succeded: "{{ update_succeded_result.user_input }}"


- name: Update failed, rollback
  command: |
    virsh undefine {{ item }}-update --remove-all-storage
  when: update_succeded == "n"

- name: Update succeded, merging images
  include_tasks: 'roles/update_image/tasks/merge_image.yml'
  loop: "{{ image_list }}"
  when: update_succeded == "y"
